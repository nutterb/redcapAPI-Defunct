#' @name exportUsers
#' @title Export Users
#' 
#' @description This method allows you to export the list of users for a 
#'   project, including their user privileges and also email address, 
#'   first name, and last name. Note: If the user has been assigned to a 
#'   user role, it will return the user with the role's defined privileges.
#'   
#' @param rcon A REDCap connection object as generated by \code{redcapConnection}.
#' @param error_handling An option for how to handle errors returned by the API.
#'   see \code{\link{redcapError}}
#' @param config \code{list} Additional configuration parameters to pass to 
#'   \code{\link[httr]{POST}}. These are appended to any parameters in 
#'   \code{rcon$config}.
#' @param api_param \code{list} Additional API parameters to pass into the
#'   body of the API call. This provides users to execute calls with options
#'   that may not otherwise be supported by \code{redcapAPI}.
#' 
#' @section REDCap Version:
#' 5.8.2+ 
#' 
#' @section Known REDCap Limitations:
#' None.
#'
#' @return 
#' Returns a data frame
#' 
#' \itemize{
#'   \item{username} 
#'   \item{email}
#'   \item{firstname} 
#'   \item{lastname}
#'   \item{expiration} 
#'   \item{data_access_group} 
#'   \item{design}
#'   \item{user_rights} 
#'   \item{data_access_groups} 
#'   \item{data_export}
#'   \item{reports}
#'   \item{stats_and_charts} 
#'   \item{manage_survey_participants} 
#'   \item{calendar}
#'   \item{data_import_tool}
#'   \item{data_comparison_tool} 
#'   \item{logging}
#'   \item{file_repository} 
#'   \item{data_quality_create} 
#'   \item{data_quality_execute} 
#'   \item{api_export}
#'   \item{api_import} 
#'   \item{mobile_app} 
#'   \item{mobile_app_download_data} 
#'   \item{record_create} 
#'   \item{record_rename} 
#'   \item{record_delete}
#'   \item{lock_records_customization} 
#'   \item{lock_records}
#'   \item{lock_records_all_forms} 
#'   \item{forms}
#' }
#'
#' @author Benjamin Nutter
#'
#' @references
#' Please refer to your institution's API documentation.
#' 
#' @export

exportUsers <- function(rcon, 
                        error_handling = getOption("redcap_error_handling", "error"), 
                        config = list(), 
                        api_param = list()){
  
  coll <- checkmate::makeAssertCollection()
  
  checkmate::assert_class(x = rcon,
                          classes = "redcapApiConnection",
                          add = coll)
  
  error_handling <- checkmate::matchArg(x = error_handling, 
                                        choices = c("null", "error"),
                                        add = coll)
  
  checkmate::assert_list(x = config,
                         names = "named",
                         add = coll)
  
  checkmate::assert_list(x = api_param, 
                         names = "named",
                         add = coll)
  
  checkmate::reportAssertions(coll)
  
  body <- list(content = "user", 
               format = "csv", 
               returnFormat = "csv")
  
  response <- makeApiCall(rcon, 
                          body = c(body, api_param), 
                          config = config)
  
  redcapError(response, error_handling = error_handling)
  
  User <- utils::read.csv(text = as.character(response),
                          stringsAsFactors = FALSE,
                          na.strings = "")
  
  User$expiration <- as.POSIXct(User$expiration)
  
  User <- exportUsers_convertLogical(User)
  
  User$data_export <- c("No Access", "Full Data Set", "De-Identified")[User$data_export + 1]
  
  FormAccess <- do.call("rbind", 
                        lapply(strsplit(User$forms, ","), 
                               make_instrument_access_columns))
  
  User <- cbind(User, FormAccess)
  
  User
}

# Unexported --------------------------------------------------------

exportUsers_convertLogical <- function(User){
  to_logical <- c("design", 
                  "user_rights", 
                  "data_access_groups", 
                  "reports", 
                  "stats_and_charts", 
                  "manage_survey_participants", 
                  "calendar", 
                  "data_import_tool", 
                  "data_comparison_tool", 
                  "logging", 
                  "file_repository", 
                  "data_quality_create", 
                  "data_quality_execute", 
                  "api_export", 
                  "api_import", 
                  "mobile_app", 
                  "mobile_app_download_data", 
                  "record_create", 
                  "record_rename", 
                  "record_delete", 
                  "lock_records_all_forms", 
                  "lock_records", 
                  "lock_records_customization")
  
  User[to_logical] <- 
    lapply(User[to_logical], 
           as.logical)
  
  User
}

make_instrument_access_columns <- function(user_form_access){
  form_access_raw <- strsplit(user_form_access, "[:]")
  
  form_name <- vapply(form_access_raw, 
                      FUN = `[`, 
                      1, 
                      FUN.VALUE = character(1))
  access_value <- lapply(form_access_raw, 
                         function(far){
                           as.logical(as.numeric(far[2]))
                         })
  
  names(access_value) <- form_name
  
  as.data.frame(access_value, 
                stringsAsFActors = FALSE)
}

# Aliases -----------------------------------------------------------

export_users <- exportUsers
