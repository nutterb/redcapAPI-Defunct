#' @name exportUsers
#' @title Export Users
#' 
#' @description This method allows you to export the list of users for a 
#'   project, including their user privileges and also email address, 
#'   first name, and last name. Note: If the user has been assigned to a 
#'   user role, it will return the user with the role's defined privileges.
#'   
#' @param rcon A REDCap connection object as generated by \code{redcapConnection}.
#' @param error_handling An option for how to handle errors returned by the API.
#'   see \code{\link{redcapError}}
#' @param config \code{list} Additional configuration parameters to pass to 
#'   \code{\link[httr]{POST}}. These are appended to any parameters in 
#'   \code{rcon$config}.
#' @param api_param \code{list} Additional API parameters to pass into the
#'   body of the API call. This provides users to execute calls with options
#'   that may not otherwise be supported by \code{redcapAPI}.
#' 
#' @section REDCap Version:
#' 5.8.2+ 
#' 
#' @section Known REDCap Limitations:
#' None.
#'
#' @return 
#' Returns a data frame
#' 
#' \itemize{
#'   \item{\code{username} user name} 
#'   \item{\code{email} user e-mail}
#'   \item{\code{firstname} first name} 
#'   \item{\code{lastname} last name}
#'   \item{\code{expiration} user rights expiration date/time} 
#'   \item{\code{data_access_group} Data access group of which user is a member} 
#'   \item{\code{data_access_group_id} The data access group ID number}
#'   \item{\code{design} user has design rights}
#'   \item{\code{user_rights} user can edit user rights} 
#'   \item{\code{data_access_groups} user can modify data access groups} 
#'   \item{\code{data_export} user can export data}
#'   \item{\code{reports} user can modify reports}
#'   \item{\code{stats_and_charts} user can modify stats and charts} 
#'   \item{\code{manage_survey_participants} user can manage survey participants} 
#'   \item{\code{calendar} user has calendar rights}
#'   \item{\code{data_import_tool} user has rights to the data import tool}
#'   \item{\code{data_comparison_tool} user has rights to the data comparison tool} 
#'   \item{\code{logging} user has access to logging}
#'   \item{\code{file_repository} user has rights for the file repository} 
#'   \item{\code{data_quality_create} user can create data quality rules} 
#'   \item{\code{data_quality_execute} user can execute data quality rules} 
#'   \item{\code{api_export} user has API export privileges}
#'   \item{\code{api_import} user has API import privileges} 
#'   \item{\code{mobile_app} user has mobile app privileges} 
#'   \item{\code{mobile_app_download_data} user has mobile app data download privileges} 
#'   \item{\code{record_create} user can create records} 
#'   \item{\code{record_rename} user can rename records} 
#'   \item{\code{record_delete} user can delete records}
#'   \item{\code{lock_records_customization} user can customize locking records}  
#'   \item{\code{lock_records} user can lock records}
#'   \item{\code{lock_records_all_forms} user can lock records across all forms} 
#'   \item{\code{forms} character value with the users access to each form. 0 
#'     indicates no access, and 1 indicates access}
#' }
#'
#' The \code{forms} column is used to create a column for each form as a 
#' logical flag indicating the user's access. This is a \code{redcapAPI} 
#' feature and is not returned by the API itself. 
#'  
#' @author Benjamin Nutter
#'
#' @references
#' Please refer to your institution's API documentation.
#' 
#' @export

exportUsers <- function(rcon, 
                        error_handling = getOption("redcap_error_handling", "error"), 
                        config = list(), 
                        api_param = list()){
  
  coll <- checkmate::makeAssertCollection()
  
  checkmate::assert_class(x = rcon,
                          classes = "redcapApiConnection",
                          add = coll)
  
  error_handling <- checkmate::matchArg(x = error_handling, 
                                        choices = c("null", "error"),
                                        add = coll)
  
  checkmate::assert_list(x = config,
                         names = "named",
                         add = coll)
  
  checkmate::assert_list(x = api_param, 
                         names = "named",
                         add = coll)
  
  checkmate::reportAssertions(coll)
  
  body <- list(content = "user", 
               format = "csv", 
               returnFormat = "csv")
  
  response <- makeApiCall(rcon, 
                          body = c(body, api_param), 
                          config = config)
  
  redcapError(response, error_handling = error_handling)
  
  User <- utils::read.csv(text = as.character(response),
                          stringsAsFactors = FALSE,
                          na.strings = "")
  
  User$expiration <- as.POSIXct(User$expiration)
  
  User <- exportUsers_convertLogical(User)
  
  User$data_export <- c("No Access", "Full Data Set", "De-Identified")[User$data_export + 1]
  
  FormAccess <- do.call("rbind", 
                        lapply(strsplit(User$forms, ","), 
                               make_instrument_access_columns))
  
  User <- cbind(User, FormAccess)
  
  User
}

# Unexported --------------------------------------------------------

exportUsers_convertLogical <- function(User){
  to_logical <- c("design", 
                  "user_rights", 
                  "data_access_groups", 
                  "reports", 
                  "stats_and_charts", 
                  "manage_survey_participants", 
                  "calendar", 
                  "data_import_tool", 
                  "data_comparison_tool", 
                  "logging", 
                  "file_repository", 
                  "data_quality_create", 
                  "data_quality_execute", 
                  "api_export", 
                  "api_import", 
                  "mobile_app", 
                  "mobile_app_download_data", 
                  "record_create", 
                  "record_rename", 
                  "record_delete", 
                  "lock_records_all_forms", 
                  "lock_records", 
                  "lock_records_customization")
  
  User[to_logical] <- 
    lapply(User[to_logical], 
           as.logical)
  
  User
}

make_instrument_access_columns <- function(user_form_access){
  form_access_raw <- strsplit(user_form_access, "[:]")
  
  form_name <- vapply(form_access_raw, 
                      FUN = `[`, 
                      1, 
                      FUN.VALUE = character(1))
  access_value <- lapply(form_access_raw, 
                         function(far){
                           as.logical(as.numeric(far[2]))
                         })
  
  names(access_value) <- form_name
  
  as.data.frame(access_value, 
                stringsAsFActors = FALSE)
}

# Aliases -----------------------------------------------------------

export_users <- exportUsers
